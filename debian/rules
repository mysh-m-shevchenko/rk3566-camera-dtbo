#!/usr/bin/make -f

export DH_VERBOSE=1
BUILDDIR=build

%:
	dh $@

override_dh_auto_clean:
	rm -rf $(BUILDDIR) debian/rk3566-camera-dtbo

override_dh_auto_build:
	mkdir -p $(BUILDDIR)
	# Compile device tree overlays with preprocessor support
	# grep -v '^#' filters out cpp line number comments that dtc doesn't understand
	for dts in overlays/*.dts; do \
		if [ -f "$$dts" ]; then \
			cpp -nostdinc -I overlays -undef -x assembler-with-cpp $$dts | \
			grep -v '^#' | \
			dtc -@ -I dts -O dtb -o $(BUILDDIR)/$$(basename $$dts .dts).dtbo -; \
		fi; \
	done

override_dh_auto_install:
	mkdir -p debian/rk3566-camera-dtbo/boot/dtbo
	mkdir -p debian/rk3566-camera-dtbo/usr/bin
	mkdir -p debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo
	mkdir -p debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo/edid
	mkdir -p debian/rk3566-camera-dtbo/lib/systemd/system
	# Copy compiled overlays
	cp $(BUILDDIR)/*.dtbo debian/rk3566-camera-dtbo/boot/dtbo/
	# Install camera-overlay utility
	install -m 755 bin/camera-overlay debian/rk3566-camera-dtbo/usr/bin/
	# Install TC358743 setup script
	install -m 755 bin/tc358743-setup debian/rk3566-camera-dtbo/usr/bin/
	# Install EDID files for TC358743
	install -m 644 edid/*edid debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo/edid/
	# Install systemd service
	install -m 644 systemd/tc358743-setup.service debian/rk3566-camera-dtbo/lib/systemd/system/
	# Install overlay list
	echo "# Available camera overlays" > debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo/overlays.list
	for dtbo in debian/rk3566-camera-dtbo/boot/dtbo/*.dtbo; do \
		basename $$dtbo .dtbo >> debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo/overlays.list; \
	done
