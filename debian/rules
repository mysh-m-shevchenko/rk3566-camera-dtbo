#!/usr/bin/make -f

%:
	dh $@

override_dh_auto_build:
	mkdir -p debian/tmp/boot/dtbo
	# Compile device tree overlays with preprocessor support
	for dts in overlays/*.dts; do \
		if [ -f "$$dts" ]; then \
			cpp -nostdinc -I overlays -undef -x assembler-with-cpp $$dts | \
			dtc -@ -I dts -O dtb -o debian/tmp/boot/dtbo/$$(basename $$dts .dts).dtbo -; \
		fi; \
	done

override_dh_auto_install:
	mkdir -p debian/rk3566-camera-dtbo/boot/dtbo
	mkdir -p debian/rk3566-camera-dtbo/usr/bin
	mkdir -p debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo
	# Copy compiled overlays
	if [ -d debian/tmp/boot/dtbo ]; then \
		cp debian/tmp/boot/dtbo/*.dtbo debian/rk3566-camera-dtbo/boot/dtbo/ 2>/dev/null || true; \
	fi
	# Install camera-overlay utility
	install -m 755 bin/camera-overlay debian/rk3566-camera-dtbo/usr/bin/
	# Install overlay list
	echo "# Available camera overlays" > debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo/overlays.list
	for dtbo in debian/rk3566-camera-dtbo/boot/dtbo/*.dtbo; do \
		basename $$dtbo .dtbo >> debian/rk3566-camera-dtbo/usr/share/rk3566-camera-dtbo/overlays.list 2>/dev/null || true; \
	done
